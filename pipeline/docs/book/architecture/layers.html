<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Layered Architecture - Pipeline Developer Guide</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Pipeline Developer Guide</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="layered-architecture"><a class="header" href="#layered-architecture">Layered Architecture</a></h1>
<p><strong>Version:</strong> 1.0
<strong>Date:</strong> 2025-01-04
<strong>SPDX-License-Identifier:</strong> BSD-3-Clause
<strong>License File:</strong> See the LICENSE file in the project root.
<strong>Copyright:</strong> © 2025 Michael Gardner, A Bit of Help, Inc.
<strong>Authors:</strong> Michael Gardner, Claude Code
<strong>Status:</strong> Active</p>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>The pipeline system is organized into four distinct layers, each with specific responsibilities and clear boundaries. This layered architecture provides separation of concerns, testability, and maintainability.</p>
<p><img src="../diagrams/layered-architecture.svg" alt="Layered Architecture" /></p>
<h2 id="the-four-layers"><a class="header" href="#the-four-layers">The Four Layers</a></h2>
<pre><code class="language-text">┌─────────────────────────────────────────┐
│         Presentation Layer              │  ← User interface (CLI)
│  - CLI commands                         │
│  - User interaction                     │
└─────────────────┬───────────────────────┘
                  │ depends on
┌─────────────────▼───────────────────────┐
│         Application Layer               │  ← Use cases, orchestration
│  - Use cases                            │
│  - Application services                 │
│  - Commands/Queries                     │
└─────────────────┬───────────────────────┘
                  │ depends on
┌─────────────────▼───────────────────────┐
│           Domain Layer                  │  ← Core business logic
│  - Entities                             │
│  - Value objects                        │
│  - Domain services (interfaces)         │
│  - Business rules                       │
└─────────────────△───────────────────────┘
                  │ implements interfaces
┌─────────────────┴───────────────────────┐
│        Infrastructure Layer             │  ← External dependencies
│  - Database repositories                │
│  - File I/O                             │
│  - External services                    │
│  - Encryption/Compression               │
└─────────────────────────────────────────┘
</code></pre>
<h2 id="dependency-rule"><a class="header" href="#dependency-rule">Dependency Rule</a></h2>
<p>The <strong>dependency rule</strong> is the most important principle in layered architecture:</p>
<blockquote>
<p><strong>Dependencies flow inward toward the domain layer.</strong></p>
</blockquote>
<ul>
<li>Presentation depends on Application</li>
<li>Application depends on Domain</li>
<li>Infrastructure depends on Domain (via interfaces)</li>
<li><strong>Domain depends on nothing</strong> (pure business logic)</li>
</ul>
<p>This means:</p>
<ul>
<li>✅ Application can use Domain types</li>
<li>✅ Infrastructure implements Domain interfaces</li>
<li>❌ Domain cannot use Application types</li>
<li>❌ Domain cannot use Infrastructure types</li>
</ul>
<h2 id="domain-layer"><a class="header" href="#domain-layer">Domain Layer</a></h2>
<h3 id="purpose"><a class="header" href="#purpose">Purpose</a></h3>
<p>The domain layer contains the <strong>core business logic</strong> and is the heart of the application. It's completely independent of external concerns like databases, user interfaces, or frameworks.</p>
<h3 id="responsibilities"><a class="header" href="#responsibilities">Responsibilities</a></h3>
<ul>
<li>Define business entities and value objects</li>
<li>Enforce business rules and invariants</li>
<li>Provide domain service interfaces</li>
<li>Emit domain events</li>
<li>Define repository interfaces</li>
</ul>
<h3 id="structure"><a class="header" href="#structure">Structure</a></h3>
<pre><code>pipeline-domain/
├── entities/
│   ├── pipeline.rs           # Pipeline entity
│   ├── pipeline_stage.rs     # Stage entity
│   ├── processing_context.rs # Processing state
│   └── security_context.rs   # Security management
├── value_objects/
│   ├── algorithm.rs          # Algorithm value object
│   ├── chunk_size.rs         # Chunk size validation
│   ├── file_path.rs          # Type-safe paths
│   └── pipeline_id.rs        # Type-safe IDs
├── services/
│   ├── compression_service.rs    # Compression interface
│   ├── encryption_service.rs     # Encryption interface
│   └── checksum_service.rs       # Checksum interface
├── repositories/
│   └── pipeline_repository.rs    # Repository interface
├── events/
│   └── domain_events.rs      # Business events
└── error/
    └── pipeline_error.rs     # Domain errors
</code></pre>
<h3 id="example"><a class="header" href="#example">Example</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Domain layer - pure business logic
pub struct Pipeline {
    id: PipelineId,
    name: String,
    stages: Vec&lt;PipelineStage&gt;,
    // ... no database or UI dependencies
}

impl Pipeline {
    pub fn new(name: String, stages: Vec&lt;PipelineStage&gt;) -&gt; Result&lt;Self, PipelineError&gt; {
        // Business rule: must have at least one stage
        if stages.is_empty() {
            return Err(PipelineError::InvalidConfiguration(
                "Pipeline must have at least one stage".to_string()
            ));
        }

        // Create pipeline with validated business rules
        Ok(Self {
            id: PipelineId::new(),
            name,
            stages,
            // ...
        })
    }
}
<span class="boring">}</span></code></pre></pre>
<h3 id="key-characteristics"><a class="header" href="#key-characteristics">Key Characteristics</a></h3>
<ul>
<li><strong>No external dependencies</strong> - Only standard library and domain types</li>
<li><strong>Highly testable</strong> - Can test without databases or files</li>
<li><strong>Portable</strong> - Can be used in any context (web, CLI, embedded)</li>
<li><strong>Stable</strong> - Rarely changes except for business requirement changes</li>
</ul>
<h2 id="application-layer"><a class="header" href="#application-layer">Application Layer</a></h2>
<h3 id="purpose-1"><a class="header" href="#purpose-1">Purpose</a></h3>
<p>The application layer orchestrates the execution of business use cases. It coordinates domain objects and delegates to domain services to accomplish specific tasks.</p>
<h3 id="responsibilities-1"><a class="header" href="#responsibilities-1">Responsibilities</a></h3>
<ul>
<li>Implement use cases (user actions)</li>
<li>Coordinate domain objects</li>
<li>Manage transactions</li>
<li>Handle application-specific workflows</li>
<li>Emit application events</li>
</ul>
<h3 id="structure-1"><a class="header" href="#structure-1">Structure</a></h3>
<pre><code>pipeline/src/application/
├── use_cases/
│   ├── process_file.rs       # File processing use case
│   ├── restore_file.rs       # File restoration use case
│   └── create_pipeline.rs    # Pipeline creation
├── services/
│   ├── pipeline_service.rs   # Pipeline orchestration
│   ├── file_processor_service.rs  # File processing
│   └── transactional_chunk_writer.rs  # Chunk writing
├── commands/
│   └── commands.rs           # CQRS commands
└── utilities/
    └── generic_service_base.rs  # Service helpers
</code></pre>
<h3 id="example-1"><a class="header" href="#example-1">Example</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Application layer - orchestrates domain objects
pub struct FileProcessorService {
    pipeline_repo: Arc&lt;dyn PipelineRepository&gt;,
    compression: Arc&lt;dyn CompressionService&gt;,
    encryption: Arc&lt;dyn EncryptionService&gt;,
}

impl FileProcessorService {
    pub async fn process_file(
        &amp;self,
        pipeline_id: &amp;PipelineId,
        input_path: &amp;FilePath,
        output_path: &amp;FilePath,
    ) -&gt; Result&lt;ProcessingMetrics, PipelineError&gt; {
        // 1. Fetch pipeline from repository
        let pipeline = self.pipeline_repo
            .find_by_id(pipeline_id)
            .await?
            .ok_or(PipelineError::NotFound)?;

        // 2. Create processing context
        let context = ProcessingContext::new(
            pipeline.id().clone(),
            input_path.clone(),
            output_path.clone(),
        );

        // 3. Process each stage
        for stage in pipeline.stages() {
            match stage.stage_type() {
                StageType::Compression =&gt; {
                    self.compression.compress(/* ... */).await?;
                }
                StageType::Encryption =&gt; {
                    self.encryption.encrypt(/* ... */).await?;
                }
                // ... more stages
            }
        }

        // 4. Return metrics
        Ok(context.metrics().clone())
    }
}
<span class="boring">}</span></code></pre></pre>
<h3 id="key-characteristics-1"><a class="header" href="#key-characteristics-1">Key Characteristics</a></h3>
<ul>
<li><strong>Thin layer</strong> - Delegates to domain for business logic</li>
<li><strong>Workflow coordination</strong> - Orchestrates multiple domain operations</li>
<li><strong>Transaction management</strong> - Ensures atomic operations</li>
<li><strong>No business logic</strong> - Business rules belong in domain layer</li>
</ul>
<h2 id="infrastructure-layer"><a class="header" href="#infrastructure-layer">Infrastructure Layer</a></h2>
<h3 id="purpose-2"><a class="header" href="#purpose-2">Purpose</a></h3>
<p>The infrastructure layer provides concrete implementations of interfaces defined in the domain layer. It handles all external concerns like databases, file systems, and third-party services.</p>
<h3 id="responsibilities-2"><a class="header" href="#responsibilities-2">Responsibilities</a></h3>
<ul>
<li>Implement repository interfaces</li>
<li>Provide database access</li>
<li>Handle file I/O operations</li>
<li>Implement compression/encryption services</li>
<li>Integrate with external systems</li>
<li>Provide logging and metrics</li>
</ul>
<h3 id="structure-2"><a class="header" href="#structure-2">Structure</a></h3>
<pre><code>pipeline/src/infrastructure/
├── repositories/
│   ├── sqlite_pipeline_repository.rs  # SQLite implementation
│   └── stage_executor.rs              # Stage execution
├── adapters/
│   ├── compression_service_adapter.rs # Compression implementation
│   ├── encryption_service_adapter.rs  # Encryption implementation
│   └── repositories/
│       └── sqlite_repository_adapter.rs  # Repository adapter
├── services/
│   └── binary_format_service.rs       # File format handling
├── metrics/
│   ├── metrics_service.rs             # Prometheus metrics
│   └── metrics_observer.rs            # Metrics collection
├── logging/
│   └── observability_service.rs       # Logging setup
└── config/
    └── config_service.rs              # Configuration management
</code></pre>
<h3 id="example-2"><a class="header" href="#example-2">Example</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Infrastructure layer - implements domain interfaces
pub struct SQLitePipelineRepository {
    pool: SqlitePool,
}

#[async_trait]
impl PipelineRepository for SQLitePipelineRepository {
    async fn find_by_id(&amp;self, id: &amp;PipelineId) -&gt; Result&lt;Option&lt;Pipeline&gt;, PipelineError&gt; {
        // Database-specific code
        let row = sqlx::query_as::&lt;_, PipelineRow&gt;(
            "SELECT * FROM pipelines WHERE id = ?"
        )
        .bind(id.to_string())
        .fetch_optional(&amp;self.pool)
        .await
        .map_err(|e| PipelineError::RepositoryError(e.to_string()))?;

        // Map database row to domain entity
        row.map(|r| self.to_domain_entity(r)).transpose()
    }

    async fn create(&amp;self, pipeline: &amp;Pipeline) -&gt; Result&lt;(), PipelineError&gt; {
        // Convert domain entity to database row
        let row = self.to_persistence_model(pipeline);

        // Insert into database
        sqlx::query(
            "INSERT INTO pipelines (id, name, ...) VALUES (?, ?, ...)"
        )
        .bind(&amp;row.id)
        .bind(&amp;row.name)
        .execute(&amp;self.pool)
        .await
        .map_err(|e| PipelineError::RepositoryError(e.to_string()))?;

        Ok(())
    }
}
<span class="boring">}</span></code></pre></pre>
<h3 id="key-characteristics-2"><a class="header" href="#key-characteristics-2">Key Characteristics</a></h3>
<ul>
<li><strong>Implements domain interfaces</strong> - Provides concrete implementations</li>
<li><strong>Database access</strong> - Handles all persistence operations</li>
<li><strong>External integrations</strong> - Communicates with external systems</li>
<li><strong>Technology-specific</strong> - Uses specific libraries and frameworks</li>
<li><strong>Replaceable</strong> - Can swap implementations without changing domain</li>
</ul>
<h2 id="presentation-layer"><a class="header" href="#presentation-layer">Presentation Layer</a></h2>
<h3 id="purpose-3"><a class="header" href="#purpose-3">Purpose</a></h3>
<p>The presentation layer handles user interaction and input/output. It translates user commands into application use cases and presents results back to the user.</p>
<h3 id="responsibilities-3"><a class="header" href="#responsibilities-3">Responsibilities</a></h3>
<ul>
<li>Parse and validate user input</li>
<li>Execute application use cases</li>
<li>Format and display output</li>
<li>Handle user interaction</li>
<li>Map errors to user-friendly messages</li>
</ul>
<h3 id="structure-3"><a class="header" href="#structure-3">Structure</a></h3>
<pre><code>pipeline/src/presentation/
├── mod.rs                    # Presentation module
└── (CLI is in main.rs)
</code></pre>
<h3 id="example-3"><a class="header" href="#example-3">Example</a></h3>
<pre><pre class="playground"><code class="language-rust">// Presentation layer - CLI interaction
#[tokio::main]
async fn main() -&gt; std::process::ExitCode {
    // 1. Parse CLI arguments
    let cli = bootstrap::bootstrap_cli()
        .unwrap_or_else(|e| {
            eprintln!("Error: {}", e);
            std::process::exit(65);
        });

    // 2. Set up dependencies (infrastructure)
    let db_pool = create_database_pool().await?;
    let pipeline_repo = Arc::new(SQLitePipelineRepository::new(db_pool));
    let compression = Arc::new(CompressionServiceAdapter::new());
    let file_processor = FileProcessorService::new(pipeline_repo, compression);

    // 3. Execute use case based on command
    let result = match cli.command {
        Commands::Process { input, output, pipeline } =&gt; {
            // Call application service
            file_processor.process_file(&amp;pipeline, &amp;input, &amp;output).await
        }
        Commands::Create { name, stages } =&gt; {
            // Call application service
            create_pipeline_service.create(&amp;name, stages).await
        }
        // ... more commands
    };

    // 4. Handle result and display to user
    match result {
        Ok(_) =&gt; {
            println!("✓ Processing completed successfully");
            ExitCode::SUCCESS
        }
        Err(e) =&gt; {
            eprintln!("✗ Error: {}", e);
            ExitCode::FAILURE
        }
    }
}</code></pre></pre>
<h3 id="key-characteristics-3"><a class="header" href="#key-characteristics-3">Key Characteristics</a></h3>
<ul>
<li><strong>Thin layer</strong> - Minimal logic, delegates to application</li>
<li><strong>User-facing</strong> - Handles all user interaction</li>
<li><strong>Input validation</strong> - Validates user input before processing</li>
<li><strong>Error formatting</strong> - Converts technical errors to user-friendly messages</li>
</ul>
<h2 id="layer-interactions"><a class="header" href="#layer-interactions">Layer Interactions</a></h2>
<h3 id="example-processing-a-file"><a class="header" href="#example-processing-a-file">Example: Processing a File</a></h3>
<p>Here's how the layers work together to process a file:</p>
<pre><code class="language-text">1. Presentation Layer (CLI)
   ↓ User runs: pipeline process --input file.txt --output file.bin --pipeline my-pipeline
   ├─ Parse command-line arguments
   ├─ Validate input parameters
   └─ Call Application Service

2. Application Layer (FileProcessorService)
   ↓ process_file(pipeline_id, input_path, output_path)
   ├─ Fetch Pipeline from Repository (Infrastructure)
   ├─ Create ProcessingContext (Domain)
   ├─ For each stage:
   │  ├─ Call CompressionService (Infrastructure)
   │  ├─ Call EncryptionService (Infrastructure)
   │  └─ Update metrics (Domain)
   └─ Return ProcessingMetrics (Domain)

3. Domain Layer (Pipeline, ProcessingContext)
   ↓ Enforce business rules
   ├─ Validate stage compatibility
   ├─ Enforce chunk sequencing
   └─ Calculate metrics

4. Infrastructure Layer (Repositories, Services)
   ↓ Handle external operations
   ├─ Query SQLite database
   ├─ Read/write files
   ├─ Compress data (brotli, zstd, etc.)
   └─ Encrypt data (AES, ChaCha20)
</code></pre>
<h2 id="benefits-of-layered-architecture"><a class="header" href="#benefits-of-layered-architecture">Benefits of Layered Architecture</a></h2>
<h3 id="separation-of-concerns"><a class="header" href="#separation-of-concerns">Separation of Concerns</a></h3>
<p>Each layer has a single, well-defined responsibility. This makes the code easier to understand and maintain.</p>
<h3 id="testability"><a class="header" href="#testability">Testability</a></h3>
<ul>
<li><strong>Domain Layer</strong>: Test business logic without any infrastructure</li>
<li><strong>Application Layer</strong>: Test workflows with mock repositories</li>
<li><strong>Infrastructure Layer</strong>: Test database operations independently</li>
<li><strong>Presentation Layer</strong>: Test user interaction separately</li>
</ul>
<h3 id="flexibility"><a class="header" href="#flexibility">Flexibility</a></h3>
<p>You can change infrastructure (e.g., swap SQLite for PostgreSQL) without touching domain or application layers.</p>
<h3 id="maintainability"><a class="header" href="#maintainability">Maintainability</a></h3>
<p>Changes in one layer typically don't affect other layers, reducing the risk of breaking existing functionality.</p>
<h3 id="parallel-development"><a class="header" href="#parallel-development">Parallel Development</a></h3>
<p>Teams can work on different layers simultaneously without conflicts.</p>
<h2 id="common-pitfalls"><a class="header" href="#common-pitfalls">Common Pitfalls</a></h2>
<h3 id="-breaking-the-dependency-rule"><a class="header" href="#-breaking-the-dependency-rule">❌ Breaking the Dependency Rule</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// WRONG: Domain depending on infrastructure
pub struct Pipeline {
    id: PipelineId,
    db_connection: SqlitePool,  // ❌ Database dependency in domain!
}
<span class="boring">}</span></code></pre></pre>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// CORRECT: Domain independent of infrastructure
pub struct Pipeline {
    id: PipelineId,
    name: String,
    stages: Vec&lt;PipelineStage&gt;,  // ✅ Pure domain types
}
<span class="boring">}</span></code></pre></pre>
<h3 id="-business-logic-in-application-layer"><a class="header" href="#-business-logic-in-application-layer">❌ Business Logic in Application Layer</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// WRONG: Business logic in application
impl FileProcessorService {
    pub async fn process_file(&amp;self, pipeline: &amp;Pipeline) -&gt; Result&lt;(), Error&gt; {
        // ❌ Business rule in application layer!
        if pipeline.stages().is_empty() {
            return Err(Error::InvalidPipeline);
        }
        // ...
    }
}
<span class="boring">}</span></code></pre></pre>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// CORRECT: Business logic in domain
impl Pipeline {
    pub fn new(name: String, stages: Vec&lt;PipelineStage&gt;) -&gt; Result&lt;Self, PipelineError&gt; {
        // ✅ Business rule in domain layer
        if stages.is_empty() {
            return Err(PipelineError::InvalidConfiguration(
                "Pipeline must have at least one stage".to_string()
            ));
        }
        Ok(Self { /* ... */ })
    }
}
<span class="boring">}</span></code></pre></pre>
<h3 id="-direct-infrastructure-access-from-presentation"><a class="header" href="#-direct-infrastructure-access-from-presentation">❌ Direct Infrastructure Access from Presentation</a></h3>
<pre><pre class="playground"><code class="language-rust">// WRONG: Presentation accessing infrastructure directly
async fn main() {
    let db_pool = create_database_pool().await?;
    // ❌ CLI directly using repository!
    let pipeline = db_pool.query("SELECT * FROM pipelines").await?;
}</code></pre></pre>
<pre><pre class="playground"><code class="language-rust">// CORRECT: Presentation using application services
async fn main() {
    let file_processor = create_file_processor().await?;
    // ✅ CLI using application service
    let result = file_processor.process_file(&amp;pipeline_id, &amp;input, &amp;output).await?;
}</code></pre></pre>
<h2 id="next-steps"><a class="header" href="#next-steps">Next Steps</a></h2>
<p>Now that you understand the layered architecture:</p>
<ul>
<li><a href="adapter-pattern.html">Hexagonal Architecture</a> - Ports and adapters pattern</li>
<li><a href="dependencies.html">Dependency Inversion</a> - Managing dependencies</li>
<li><a href="domain-model.html">Domain Model</a> - Deep dive into the domain layer</li>
<li><a href="repository-pattern.html">Repository Pattern</a> - Data persistence abstraction</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../architecture/overview.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../architecture/dependencies.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../architecture/overview.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../architecture/dependencies.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
