@startuml data-flow
!define LIGHTBLUE #E3F2FD
!define BLUE #2196F3
!define DARKBLUE #1565C0
!define LIGHTGREEN #E8F5E9
!define GREEN #4CAF50
!define LIGHTORANGE #FFF3E0
!define ORANGE #FF9800

skinparam activity {
    BackgroundColor LIGHTBLUE
    BorderColor BLUE
    ArrowColor DARKBLUE
    DiamondBackgroundColor LIGHTORANGE
    DiamondBorderColor ORANGE
}

title Data Flow Diagram - File Processing Pipeline

|User|
start
:Input File;
note right
  User provides:
  - File path
  - Pipeline configuration
  - Encryption key (optional)
end note

|System|
:Validate Input;
note right
  - Check file exists
  - Verify permissions
  - Validate pipeline config
end note

:Read File Metadata;
:Split File into Chunks\n(Default: 1MB);
note right
  Chunk structure:
  - ID (sequential)
  - Data (bytes)
  - Is final flag
end note

fork
    :Process Chunk 1;
fork again
    :Process Chunk 2;
fork again
    :Process Chunk 3;
fork again
    :Process Chunk N;
end fork

note right
  Parallel chunk processing
  utilizing multiple CPU cores
end note

partition "Per-Chunk Pipeline Processing" {
    :Stage 1: Compression;
    note right
      Algorithms:
      - Brotli (best ratio)
      - Zstd (balanced)
      - Gzip (compatible)
      - LZ4 (fastest)
    end note

    :Stage 2: Encryption;
    note right
      Algorithms:
      - AES-256-GCM
      - ChaCha20-Poly1305
      With AEAD for integrity
    end note

    :Stage 3: Checksum;
    note right
      Algorithms:
      - SHA-256
      - SHA-512
      - BLAKE3
    end note
}

:Combine Processed Chunks;

:Write .adapipe File Header;
note right
  Header contains:
  - Magic number "ADPI"
  - Version
  - Pipeline configuration
  - Original filename
  - Chunk count
end note

:Write Chunk Data;
note right
  For each chunk:
  - Length (4 bytes)
  - Checksum (32 bytes)
  - Data (variable)
end note

:Write Footer;
note right
  Footer contains:
  - Total checksum
  - Creation timestamp
end note

:Save Metadata to Database;
note right
  Store:
  - Pipeline ID
  - File paths
  - Sizes
  - Processing timestamp
end note

|User|
:Output .adapipe File;
stop

@enduml
